let test = {
  lat: 33.4418,
  lon: -94.0377,
  timezone: "America/Chicago",
  timezone_offset: -21600,
  current: {
    dt: 1611858035,
    sunrise: 1611839674,
    sunset: 1611877414,
    temp: 278.82,
    feels_like: 274.59,
    pressure: 1037,
    humidity: 56,
    dew_point: 271.02,
    uvi: 4.17,
    clouds: 1,
    visibility: 10000,
    wind_speed: 2.74,
    wind_deg: 68,
    weather: [
      {
        id: 800,
        main: "Clear",
        description: "clear sky",
        icon: "01d",
      },
    ],
  },
  daily: [
    {
      dt: 1611856800,
      sunrise: 1611839674,
      sunset: 1611877414,
      temp: {
        day: 278.82,
        min: 271.97,
        max: 281.66,
        night: 275.74,
        eve: 278.45,
        morn: 272.19,
      },
      feels_like: {
        day: 274.59,
        night: 272.16,
        eve: 275.51,
        morn: 267.72,
      },
      pressure: 1037,
      humidity: 56,
      dew_point: 271.02,
      wind_speed: 2.74,
      wind_deg: 68,
      weather: [
        {
          id: 800,
          main: "Clear",
          description: "clear sky",
          icon: "01d",
        },
      ],
      clouds: 1,
      pop: 0,
      uvi: 4.17,
    },
    {
      dt: 1611943200,
      sunrise: 1611926037,
      sunset: 1611963873,
      temp: {
        day: 283.35,
        min: 274.34,
        max: 285.56,
        night: 281.4,
        eve: 281.37,
        morn: 274.34,
      },
      feels_like: {
        day: 279.3,
        night: 277.4,
        eve: 278.14,
        morn: 271.07,
      },
      pressure: 1026,
      humidity: 61,
      dew_point: 276.19,
      wind_speed: 3.65,
      wind_deg: 172,
      weather: [
        {
          id: 803,
          main: "Clouds",
          description: "broken clouds",
          icon: "04d",
        },
      ],
      clouds: 76,
      pop: 0,
      uvi: 4.05,
    },
    {
      dt: 1612029600,
      sunrise: 1612012399,
      sunset: 1612050332,
      temp: {
        day: 287.61,
        min: 281.76,
        max: 292.37,
        night: 283.52,
        eve: 288.38,
        morn: 284.22,
      },
      feels_like: {
        day: 282.99,
        night: 279.43,
        eve: 283.41,
        morn: 279.91,
      },
      pressure: 1008,
      humidity: 91,
      dew_point: 286.29,
      wind_speed: 7.93,
      wind_deg: 187,
      weather: [
        {
          id: 500,
          main: "Rain",
          description: "light rain",
          icon: "10d",
        },
      ],
      clouds: 100,
      pop: 1,
      rain: 3.56,
      uvi: 1.78,
    },
    {
      dt: 1612116000,
      sunrise: 1612098760,
      sunset: 1612136790,
      temp: {
        day: 283.4,
        min: 278.75,
        max: 286.07,
        night: 278.75,
        eve: 281.8,
        morn: 278.84,
      },
      feels_like: {
        day: 278.38,
        night: 274.6,
        eve: 277.6,
        morn: 274.49,
      },
      pressure: 1020,
      humidity: 66,
      dew_point: 277.37,
      wind_speed: 5.34,
      wind_deg: 323,
      weather: [
        {
          id: 802,
          main: "Clouds",
          description: "scattered clouds",
          icon: "03d",
        },
      ],
      clouds: 41,
      pop: 0,
      uvi: 3.49,
    },
    {
      dt: 1612202400,
      sunrise: 1612185119,
      sunset: 1612223249,
      temp: {
        day: 284.09,
        min: 275.67,
        max: 286.15,
        night: 279.56,
        eve: 281.97,
        morn: 275.67,
      },
      feels_like: {
        day: 279.54,
        night: 276.69,
        eve: 278.95,
        morn: 271.36,
      },
      pressure: 1026,
      humidity: 50,
      dew_point: 274.31,
      wind_speed: 3.86,
      wind_deg: 343,
      weather: [
        {
          id: 800,
          main: "Clear",
          description: "clear sky",
          icon: "01d",
        },
      ],
      clouds: 0,
      pop: 0,
      uvi: 3.91,
    },
    {
      dt: 1612288800,
      sunrise: 1612271477,
      sunset: 1612309708,
      temp: {
        day: 284.13,
        min: 276.29,
        max: 286.09,
        night: 279.78,
        eve: 282.08,
        morn: 276.29,
      },
      feels_like: {
        day: 280.48,
        night: 276.01,
        eve: 278.86,
        morn: 273.2,
      },
      pressure: 1023,
      humidity: 57,
      dew_point: 275.99,
      wind_speed: 3.01,
      wind_deg: 146,
      weather: [
        {
          id: 804,
          main: "Clouds",
          description: "overcast clouds",
          icon: "04d",
        },
      ],
      clouds: 86,
      pop: 0,
      uvi: 4,
    },
    {
      dt: 1612375200,
      sunrise: 1612357833,
      sunset: 1612396166,
      temp: {
        day: 286.73,
        min: 277.95,
        max: 287.18,
        night: 286.97,
        eve: 286.4,
        morn: 277.95,
      },
      feels_like: {
        day: 281.99,
        night: 282.12,
        eve: 282.19,
        morn: 273.37,
      },
      pressure: 1013,
      humidity: 68,
      dew_point: 281.01,
      wind_speed: 6.03,
      wind_deg: 169,
      weather: [
        {
          id: 803,
          main: "Clouds",
          description: "broken clouds",
          icon: "04d",
        },
      ],
      clouds: 82,
      pop: 0.28,
      uvi: 4,
    },
    {
      dt: 1612461600,
      sunrise: 1612444188,
      sunset: 1612482624,
      temp: {
        day: 280.37,
        min: 276.92,
        max: 290,
        night: 276.92,
        eve: 279.3,
        morn: 288.82,
      },
      feels_like: {
        day: 274.41,
        night: 271.39,
        eve: 273.32,
        morn: 285.54,
      },
      pressure: 1005,
      humidity: 85,
      dew_point: 278.08,
      wind_speed: 6.87,
      wind_deg: 295,
      weather: [
        {
          id: 500,
          main: "Rain",
          description: "light rain",
          icon: "10d",
        },
      ],
      clouds: 100,
      pop: 1,
      rain: 4.4,
      uvi: 4,
    },
  ],
};

// clock
const getTime = (onlyWD = false) => {
  const weekDays = [
    "Domingo",
    "Segunda-Feira",
    "Terça-Feira",
    "Quarta-Feira",
    "Quinta-Feira",
    "Sexta-Feira",
    "Sabado",
  ];
  const newTime = new Date();
  const newHour = newTime.getHours();
  const newMinute = newTime.getMinutes();
  const newDay = newTime.getDate();
  const newWeekDay = weekDays[newTime.getDay()];

  if (onlyWD) {
    return [newWeekDay, weekDays];
  }
  return [newHour, newMinute, newDay, newWeekDay];
};

const getNextDays = (nDays) => {
  let daysList = getTime(true);
  let retDays = [];

  let index = daysList[1].indexOf(daysList[0]) + 1;
  for (let i = 0; i <= nDays; i++) {
    if (index > 6) {
      index = 0;
    }
    retDays.push(daysList[1][index]);
    index++;
  }

  return retDays;
};

const weatherTime = document.getElementById("weather-time");
const handleClock = () => {
  let newTime = getTime();

  weatherTime.innerHTML = `${newTime[0]}:${
    newTime[1] > 9 ? newTime[1] : `0${newTime[1]}`
  }<span>${newTime[2]}, ${newTime[3]}</span>`;
};

// remove
const removeError = () => {
  document.getElementById("error").style.display = "none";
};

const removeWelcome = () => {
  document.getElementById("welcome-div").style.display = "none";
};

const removeLoading = () => {
  document.getElementById("main-container").classList.remove("loading");
};

const removeAll = () => {
  removeWelcome();
  removeLoading();
  removeError();
};

// error
let hasFetch = false;
const seeDemo = () => {
  removeError();
  removeLoading();
};

const showError = () => {
  document.getElementById("error").style.display = "block";
  removeWelcome();
};

// handle weather
const selectImg = (id) => {
  if (id >= 200 && id <= 232) {
    return "/images/tempestate.png";
  } else if ((id >= 300 && id <= 321) || (id >= 520 && id <= 531)) {
    return "/images/garoa.png";
  } else if (id >= 500 && id <= 504) {
    return "/images/chuva.png";
  } else if (id === 511) {
    return "/images/chuva-congelante.png";
  } else if (id >= 600 && id <= 622) {
    return "/images/neve.png";
  } else if (id >= 701 && id <= 781) {
    return "/images/atmosfera.png";
  } else if (id === 800) {
    return "/images/ceu-limpo.png";
  } else if (id === 801 || id === 802) {
    return "/images/algumas-nuvens.png";
  } else if (id === 803 || id === 804) {
    return "/images/muitas-nuvens.png";
  } else {
    return "/images/clima.png";
  }
};

const handleObj = (obj) => {
  const {
    temp,
    feels_like,
    humidity,
    clouds,
    wind_speed,
    weather,
  } = obj.current;
  const {
    temp: { min, max },
  } = obj.daily[0];

  const kelvinToC = (value) => value - 273.15;

  const weatherImg = document.getElementById("weather-img");
  weatherImg.firstElementChild.src = selectImg(weather[0].id);
  weatherImg.firstElementChild.alt = weather[0].description;
  weatherImg.lastElementChild.textContent = `${kelvinToC(temp).toFixed(1)}º`;

  const weatherInfo = document.getElementById("weather-info").children;
  weatherInfo[0].textContent = `${weather[0].description}`;
  weatherInfo[1].textContent = `Sensação Termica: ${kelvinToC(
    feels_like
  ).toFixed(2)}º`;
  weatherInfo[2].textContent = `Máxima: ${kelvinToC(max).toFixed(2)}º`;
  weatherInfo[3].textContent = `Mínima: ${kelvinToC(min).toFixed(2)}º`;
  weatherInfo[4].textContent = `Humidade: ${humidity}%`;
  weatherInfo[5].textContent = `Nebulosidade: ${clouds}%`;
  weatherInfo[6].textContent = `Velocidade do Vento: ${wind_speed.toFixed(
    2
  )}m/s`;

  const weatherDays = document.getElementById("weather-days").children;
  const nextDays = getNextDays(6);
  for (let i = 0; i < weatherDays.length; i++) {
    const {
      temp: { min: dailyMin, max: dailyMax },
      weather: dailyWeather,
    } = obj.daily[i + 1];
    weatherDays[i].children[0].src = selectImg(dailyWeather[0].id);
    weatherDays[i].children[0].alt = dailyWeather[0].description;
    weatherDays[i].children[1].textContent = `${nextDays[i].slice(0, 3)}`;
    weatherDays[i].children[2].textContent = `${parseInt(
      kelvinToC(dailyMin)
    )}º / ${parseInt(kelvinToC(dailyMax))}º`;
  }
};

//"https://api.openweathermap.org/data/2.5/onecall?lat=33.441792&lon=-94.037689&lang=pt_br&exclude=hourly,minutely&appid=b60cdd3bc4b5e2602c1e98fa10709a32"

//"https://api.openweathermap.org/data/2.5/onecall?lat=-27.433330&lon=-48.408810&lang=pt_br&exclude=hourly,minutely&appid=b60cdd3bc4b5e2602c1e98fa10709a32"

const handleWeather = async (posLatLon) => {
  try {
    const resp = await fetch(
      `https://api.openweathermap.org/data/2.5/onecall?lat=${posLatLon[0]}&lon=${posLatLon[1]}&lang=pt_br&exclude=hourly,minutely&appid=b60cdd3bc4b5e2602c1e98fa10709a32`
    );
    const ret = await resp.json();

    handleObj(ret);
    hasFetch = true;
    removeAll();
  } catch (error) {
    hasFetch = false;
  }
};

//map
function initMap(posLatLon) {
  let map = new google.maps.Map(document.getElementById("map"), {
    center: { lat: posLatLon[0], lng: posLatLon[1] },
    zoom: 15,
  });
}

// init
const welcome = async () => {
  const welcomeDiv = document.getElementById("welcome-div");

  // get position
  let posLatLon = [];
  navigator.geolocation.getCurrentPosition(
    (pos) => {
      posLatLon = [pos.coords.latitude, pos.coords.longitude];

      // call weather
      handleWeather(posLatLon);
      initMap(posLatLon);
    },
    (err) => {
      alert(
        "ERROR(" +
          err.code +
          "): " +
          err.message +
          ". Será usado a localização padrão!"
      );
      posLatLon = [-27.5969, -48.5495];
      handleWeather(posLatLon);
      initMap(posLatLon);
    }
  );

  setTimeout(() => {
    welcomeDiv.lastElementChild.style.visibility = "visible";
    welcomeDiv.lastElementChild.style.opacity = "1";
  }, 1000);

  setTimeout(() => {
    if (!hasFetch) {
      showError();
    }
  }, 5000);
};

// at start
(() => {
  handleClock();
  setInterval(handleClock, 5000);
  document.getElementById("btn-see-demo").addEventListener("click", seeDemo);
  welcome();
})();
